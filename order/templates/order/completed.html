{% extends 'base/base.html' %}
{% block maincontent %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KG Bites - Order Management System">
    <title>KG Bites - Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light text-dark d-flex flex-column min-vh-100">


    <main class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h4">Completed Orders</h1>
            <div>
                <button onclick="clearCompletedOrders()" class="btn btn-danger btn-sm">Clear Completed Orders</button>
                <a href="{% url 'download_summary' %}" class="btn btn-success btn-sm">Download Summary</a>
            </div>
            <div>
                <a href="{% url 'transfer_completed' %}" class="btn btn-success btn-sm">Transfer complted</a>
            </div>
        </div>
        <div class="card">
            <div class="card-header bg-primary text-white">Completed Orders</div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer Name</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            {% if order.status == 'Completed' %}
                                <tr>
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.rfid_name }}</td>
                                    <td>₹{{ order.total_amount }}</td>
                                    <td>
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="order_id" value="{{ order.id }}">
                                            <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                                {% for status_value, status_label in order.STATUS_CHOICES %}
                                                    <option value="{{ status_value }}" {% if order.status == status_value %}selected{% endif %}>
                                                        {{ status_label }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </form>
                                    </td>
                                    <td>
                                        <button onclick="toggleOrderDetails({{ order.id }})" class="btn btn-primary btn-sm">View Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="5">
                                        <div id="order-details-{{ order.id }}" class="d-none">
                                            <div id="details-content-{{ order.id }}" class="p-3 bg-light">
                                                <div class="spinner-border text-primary" role="status"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        function toggleOrderDetails(orderId) {
            const detailsDiv = document.getElementById(`order-details-${orderId}`);
            const detailsContent = document.getElementById(`details-content-${orderId}`);
            
            if (detailsDiv.classList.contains('d-none')) {
                detailsDiv.classList.remove('d-none');
                fetch(`/orders/details/${orderId}/`)
                    .then(response => response.json())
                    .then(data => {
                        const itemsHtml = data.items.map(item => 
                            `<li>${item.name} - ₹${item.price} x ${item.quantity}</li>`).join('');
                        detailsContent.innerHTML = `
                            <strong>Order ID:</strong> ${data.order_id}<br>
                            <strong>Amount Paid:</strong> ₹${data.total_amount}<br>
                            <strong>Items:</strong><ul>${itemsHtml}</ul>
                        `;
                    })
                    .catch(() => {
                        detailsContent.innerHTML = `<div class="text-danger">Failed to load details.</div>`;
                    });
            } else {
                detailsDiv.classList.add('d-none');
            }
        }

        function clearCompletedOrders() {
            fetch('/clear-completed-orders/', {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => {
                if (response.ok) {
                    document.querySelectorAll('tr').forEach(row => {
                        if (row.querySelector('select')?.value === 'Completed') row.remove();
                    });
                }
            });
        }
    </script>
</body>
</html>
{% endblock maincontent %}